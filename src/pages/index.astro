---
import type { AppsData } from "../types/app";
import { promises as fs } from "fs";
import path from "path";
import LastUpdated from "../components/LastUpdated.astro";
import AppCard from "../components/AppCard.svelte";
import "../styles/global.css";

let appsData: AppsData | null = null;
let error: string | null = null;

try {
  const dataPath = path.join(process.cwd(), "src", "data", "apps.json");
  const fileContent = await fs.readFile(dataPath, "utf-8");
  appsData = JSON.parse(fileContent) as AppsData;
} catch (e) {
  if (e instanceof Error) {
    if ("code" in e && e.code === "ENOENT") {
      error = "ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'bun run update' ã‚’å®Ÿè¡Œã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚";
    } else {
      error = `ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}`;
    }
  } else {
    error = "äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
  }
}
---

<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>App Dashboard</title>
    <meta name="description" content="Mobile app development dashboard" />
  </head>
  <body>
    <main>
      <header class="header">
        <h1>ğŸš€ App Development Dashboard</h1>
        {appsData && (
          <div class="flex items-center gap-5 mt-2">
            <LastUpdated lastUpdated={appsData.lastUpdated} />
            <span class="text-gray-600 text-sm">ã‚¢ãƒ—ãƒªæ•°: {appsData.apps.length}</span>
          </div>
        )}
      </header>
      
      {error ? (
        <div class="p-5 bg-error-50 border border-error-200 rounded m-5">
          <strong>ã‚¨ãƒ©ãƒ¼:</strong> {error}
        </div>
      ) : appsData ? (
        <div class="apps-grid">
          {appsData.apps.map((app) => (
            <AppCard app={app} client:load />
          ))}
        </div>
      ) : (
        <p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
      )}
    </main>
  </body>
</html>