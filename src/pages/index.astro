---
import type { AppsData } from "../types/app";
import { promises as fs } from "fs";
import path from "path";
import LastUpdated from "../components/LastUpdated.astro";
import AppCard from "../components/AppCard.svelte";

let appsData: AppsData | null = null;
let error: string | null = null;

try {
  const dataPath = path.join(process.cwd(), "src", "data", "apps.json");
  const fileContent = await fs.readFile(dataPath, "utf-8");
  appsData = JSON.parse(fileContent) as AppsData;
} catch (e) {
  if (e instanceof Error) {
    if ("code" in e && e.code === "ENOENT") {
      error = "データファイルが見つかりません。'bun run update' を実行してデータを生成してください。";
    } else {
      error = `データの読み込みに失敗しました: ${e.message}`;
    }
  } else {
    error = "予期しないエラーが発生しました。";
  }
}
---

<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>App Dashboard</title>
    <meta name="description" content="Mobile app development dashboard" />
  </head>
  <body>
    <main>
      <header style="margin-bottom: 30px; padding: 20px; background-color: #fafafa; border-radius: 8px;">
        <h1 style="margin: 0 0 10px 0;">App Dashboard</h1>
        {appsData && (
          <div style="display: flex; align-items: center; gap: 20px; margin-top: 10px;">
            <LastUpdated lastUpdated={appsData.lastUpdated} />
            <span style="color: #666; font-size: 0.9rem;">アプリ数: {appsData.apps.length}</span>
          </div>
        )}
      </header>
      
      {error ? (
        <div style="padding: 20px; background-color: #fee; border: 1px solid #fcc; border-radius: 4px; margin: 20px;">
          <strong>エラー:</strong> {error}
        </div>
      ) : appsData ? (
        <div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 20px;">
            {appsData.apps.map((app) => (
              <AppCard app={app} client:load />
            ))}
          </div>
        </div>
      ) : (
        <p>データを読み込み中...</p>
      )}
    </main>
  </body>
</html>