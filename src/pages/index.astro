---
import type { AppsData } from "../types/app";
import { promises as fs } from "fs";
import path from "path";
import LastUpdated from "../components/LastUpdated.astro";
import PlatformBadge from "../components/PlatformBadge.svelte";
import ProgressBar from "../components/ProgressBar.svelte";
import PRStateLabel from "../components/PRStateLabel.svelte";

let appsData: AppsData | null = null;
let error: string | null = null;

try {
  const dataPath = path.join(process.cwd(), "src", "data", "apps.json");
  const fileContent = await fs.readFile(dataPath, "utf-8");
  appsData = JSON.parse(fileContent) as AppsData;
} catch (e) {
  if (e instanceof Error) {
    if ("code" in e && e.code === "ENOENT") {
      error = "ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'bun run update' ã‚’å®Ÿè¡Œã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚";
    } else {
      error = `ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}`;
    }
  } else {
    error = "äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
  }
}
---

<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>App Dashboard</title>
    <meta name="description" content="Mobile app development dashboard" />
  </head>
  <body>
    <main>
      <header style="margin-bottom: 30px; padding: 20px; background-color: #fafafa; border-radius: 8px;">
        <h1 style="margin: 0 0 10px 0;">App Dashboard</h1>
        {appsData && (
          <div style="display: flex; align-items: center; gap: 20px; margin-top: 10px;">
            <LastUpdated lastUpdated={appsData.lastUpdated} />
            <span style="color: #666; font-size: 0.9rem;">ã‚¢ãƒ—ãƒªæ•°: {appsData.apps.length}</span>
          </div>
        )}
      </header>
      
      {error ? (
        <div style="padding: 20px; background-color: #fee; border: 1px solid #fcc; border-radius: 4px; margin: 20px;">
          <strong>ã‚¨ãƒ©ãƒ¼:</strong> {error}
        </div>
      ) : appsData ? (
        <div>
          <div style="display: grid; gap: 20px; margin-top: 20px;">
            {appsData.apps.map((app) => (
              <div style="padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                  <img src={app.icon} alt={app.name} width="60" height="60" style="border-radius: 12px;" />
                  <div>
                    <h2 style="margin: 0;">{app.name}</h2>
                    <p style="margin: 0; color: #666;">{app.repository}</p>
                    <p style="margin: 0;">
                      <PlatformBadge platform={app.platform} />
                    </p>
                  </div>
                </div>
                
                {app.latestRelease && (
                  <div style="margin-top: 15px;">
                    <strong>æœ€æ–°ãƒªãƒªãƒ¼ã‚¹:</strong> 
                    <a href={app.latestRelease.url} target="_blank" rel="noopener noreferrer">
                      {app.latestRelease.version}
                    </a>
                    ({app.latestRelease.date})
                  </div>
                )}
                
                <ProgressBar milestone={app.milestone} client:load />

                {app.recentPRs && app.recentPRs.length > 0 && (
                  <div style="margin-top: 15px;">
                    <strong>ğŸ“ Recent Pull Requests</strong>
                    <ul style="margin-top: 8px; padding: 0;">
                      {app.recentPRs.slice(0, 3).map((pr) => (
                        <PRStateLabel 
                          client:load
                          state={pr.state}
                          prNumber={pr.number}
                          title={pr.title}
                        />
                      ))}
                    </ul>
                  </div>
                )}
                
                <div style="margin-top: 10px;">
                  <a href={app.links.github} target="_blank" rel="noopener noreferrer">GitHub</a>
                  {app.links.appStore && (
                    <> | <a href={app.links.appStore} target="_blank" rel="noopener noreferrer">App Store</a></>
                  )}
                  {app.links.playStore && (
                    <> | <a href={app.links.playStore} target="_blank" rel="noopener noreferrer">Play Store</a></>
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>
      ) : (
        <p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
      )}
    </main>
  </body>
</html>